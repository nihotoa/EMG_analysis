%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%{
roll of this function:
calculate & plot x_corr of each W_synergy

how to use:
plase conduct this func after 'plotXcorr.m'
pre_operate:plotXcorr_W
post_operate:testWplot_tf (if you will concduct anova) 

save_data:
【figure】Yachimun -> easyData -> P-DATA(old filter TTakei delayed) -> EachPlotx_corr_result -> dist-dist
【data】 not defined yet!!
【caution!!!】
please change group_num!!!!!!!
(変数group_numの値を適宜変更して!!!!)
【懸念点】
ここで使用している空間シナジーは、各タイミング周りではなく、タスク全体からの空間シナジーである(時間シナジーの方の相互相関は各タイミングで分けて計算している一方で)
【やること】
プロットに使用したデータをどこかしらに保存する
プロットのLineWidthを変更する(細すぎ)
%}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
clear
%% set param
monkeyname = 'Ya';

days = {...
%        % pre-surgery
%          170405; ...
% %          170406; ...
%          170410; ...
%          170411; ...
%          170412; ...
%          170413; ...
% % %          170414; ...
%          170419; ...
%          170420; ...
% %          170421; ...
%          170424; ...
%          170425; ...
% %          170426; ...
%          170501; ...
% % %          170502; ...
%          170508; ...
%          170509; ...
% % %           170510; ...
%          170511; ...
%          170512; ...
%          170515; ...
         170516; ...
         170517; ...
         170524; ...
         170526; ...
%          170529; ...
% % %         170605	; ...%post-surgery()
%         170606	; ...
% %         170607	; ...
%         170608	; ...
%         170612	; ...
%         170613	; ...
%         170614	; ...
%         170615	; ...
%         170616	; ...
% % %         170619	; ...
%         170620	; ...
%         170621	; ...
%         170622	; ...
%         170623	; ...
%         170627	; ...
        170628	; ...
        170629	; ...
        170630	; ...
        170703	; ...
        170704	; ...
% %         170705	; ...
        170706	; ...%orange
        170707	; ...
        170710	; ...
        170711	; ...
        170712	; ...
        170713	; ...
        170714	; ...
        170718	; ...
        170719	; ...
        170720	; ...
        170725	; ...
        170726	; ...
% %         170801	; ...
        170802	; ...
        170803	; ...
        170804	; ...
        170807	; ...
        170808	; ...
        170809	; ...
        170810	; ...
        170815	; ...
%         170816	; ...
        170817	; ...
        170818	; ...
        170822	; ...
%         170823	; ...
         170824	; ...
         170825	; ...
        170829	; ...
        170830	; ...
         170831	; ...
        170901	; ...
         170904	; ...
        170905	; ...
        170906	; ...
        170907	; ...
        170908	; ...
        170911	; ...
        170913	; ...
        170914	; ...
        170925  ; ...
        170926  ; ...
        170927  ; ...
        170929  ; ...
         }';

% days = [170703 170707 170711 170714 170720 170802 170824 170830 170907 170914 170925];
%   days = [170517 170524 170526 170529];
 group_num = 6; %デフォルトだと1になっていた
 syn_num = 4;
 switch group_num
    case 1
        %without 'Deltoid'
        EMG_num = 12;
        EMGs = {'BRD';'ECR';'ECU';'ED23';'EDCdist';'EDCprox';'FCR';'FCU';'FDP';...
                'FDSdist';'FDSprox';'PL'};
    case 2
        %only extensor
        EMG_num = 5;
        EMGs = {'ECR';'ECU';'ED23';'ED45';'EDC'};
    case 3
        %only flexor
        EMG_num = 4;
        EMGs = {'FCR';'FCU';'FDP';'FDS'};
    case 4
        %forearm
        EMG_num = 10;
        EMGs = {'BRD';'ECR';'ECU';'ED23';'ED45';'EDC';'FCR';'FCU';'FDP';'FDS'};
    case 5
        %forearm
        EMG_num = 11;
        EMGs = {'BRD';'ECR';'ECU';'ED23';'ED45';'EDC';'FCR';'FCU';'FDP';'FDS';'Triceps'};
    case 6
        %太田解析用(dist-dist)
        EMG_num = 10;
        EMGs = {'BRD';'ECR';'ECU';'ED45';'EDCdist';'FCR';'FCU';'FDP';'FDSdist';'PL'};  
    case 7
        %太田解析用(prox-prox)
        EMG_num = 10;
        EMGs = {'BRD';'ECR';'ECU';'ED45';'EDCprox';'FCR';'FCU';'FDP';'FDSprox';'PL'};  
    case 8
        EMG_num = 10;
        %太田解析(prox-dist)
        EMGs = {'BRD';'ECR';'ECU';'ED45';'EDCprox';'FCR';'FCU';'FDP';'FDSdist';'PL'};      
    case 9
        EMG_num = 10;
        %太田解析(dist-prox)
        EMGs = {'BRD';'ECR';'ECU';'ED45';'EDCdist';'FCR';'FCU';'FDP';'FDSprox';'PL'};      
end
 
% days = [180928 181019];
% EMGgroups = [1,1];
% EMG_num = 12;

save_data = 1;
save_fig = 1;
data_fold = 'new_nmf_result'; %fill in the name of directry which contain W_syn Data 
control_data_day = [170516 170517 170524 170526];
surgery_day = 170530;
synergy_combination = 'dist-dist';
%% code section
% load W_synergy data
Wx =  cell(1,length(days));

for i = 1:length(days)
    if i == 1
        cd ../../
        load(['new_nmf_result/order_tim_list/' monkeyname num2str(days{1}) 'to' num2str(days{end}) '_' num2str(length(days)) '/' monkeyname num2str(days{1}) 'to' num2str(days{end}) '_' num2str(length(days)) '_' num2str(syn_num) '.mat'],'k_arr')
    end
    reference_dir = [data_fold '/' monkeyname num2str(cell2mat(days(i))) '/' monkeyname num2str(cell2mat(days(i)))  '_syn_result_' sprintf('%d',EMG_num) '/' monkeyname num2str(cell2mat(days(i))) '_W'];
    load([reference_dir '/' monkeyname num2str(cell2mat(days(i))) '_aveW_' sprintf('%d',syn_num)],'aveW');
    Wx{i} = aveW;
    if i == length(days)
        cd easyData/P-Data(old filter TTakei delayed)    
    end
end

%align W_synenrgy with using k_arr (dispNMFで求めたk_arr(各日のシナジーの対応づけ)をもとに、Wxを整列しWtに代入する)
for i = 1:length(days)
    for j = 1:syn_num
        Wt{1,i}(:,j) = Wx{1,i}(:,k_arr(j,i));
    end
end

%create control data(to use referene of x_corr analysis)
reference_data = [days;Wt];
control_data = zeros(EMG_num,syn_num);
for ii = 1:syn_num
    clear control_data_sel
    control_data_sel = zeros(EMG_num,length(control_data_day));
    for jj = 1:length(control_data_day)
        applicable_date = find(cell2mat(reference_data(1,:)) == control_data_day(jj));
        control_data_sel(:,jj) = reference_data{2,applicable_date}(:,ii);
    end
    %↓170524のシナジーと2が逆転している(もともとこの時点で揃っていない)→ disp_NMF_Wを参照しながら、シナジーを正しく並び替える必要がある
    control_data(:,ii) = mean(control_data_sel,2);
end

%calcurete x_corr (vs control data)
result = cell(syn_num,1);
for i = 1:syn_num
    result{i} = zeros(syn_num,length(days));
    for j = 1:length(days)
        for k = 1:syn_num
            R = corrcoef(Wt{:,j}(:,i),control_data(:,k));
            result{i}(k,j) = R(1,2);
        end
    end
end

%change data_format for plotting figure(図のプロットのためのデータを作成する)
zero_day = trans_calrender(surgery_day);
Elapsed_days = zeros(1,length(days));
control_data_Elapsed_days = zeros(1,length(control_data_day));
count = 1;
for ii = 1:length(days)
    Elapsed_day = caldays(CountElapsedDate(days{ii}, zero_day));
    Elapsed_days(ii) = Elapsed_day;
    if ismember(days{ii}, control_data_day)
        control_data_Elapsed_days(1,count) = Elapsed_day;
        count = count + 1;
    end
end

%plot synergy_W xcorr with using 'result'
h = figure();
h.WindowState = 'maximized';
post_first_day =  min(Elapsed_days(Elapsed_days > 0 ));
xnoT = 0:(post_first_day - 1);
for ii = 1:syn_num
    subplot(2,2,ii)
    fi1 = fill([control_data_Elapsed_days control_data_Elapsed_days(end:-1:1)],[ones(size(control_data_Elapsed_days)) (-1).*ones(size(control_data_Elapsed_days))],'k');
    fi1.FaceColor = [0.78 0.78 0.78];       % make the filled area
    fi1.EdgeColor = 'none';            % remove the line around the filled area
    hold on;
    for jj = 1:syn_num
        plot(Elapsed_days,result{ii}(jj,:),'LineWidth',1.5);
    end
    ylim([-1 1])
    xlim([Elapsed_days(1) Elapsed_days(end)])
    ylabel('Cross-correlation coefficient','FontSize',20);
    xlabel('Post tendon transfer [days]','FontSize',20)
    title(['Synergy' num2str(ii)],'FontSize',30)
    fi2 = fill([xnoT xnoT(end:-1:1)],[ones(size(xnoT)) (-1).*ones(size(xnoT))],'k','LineWidth',1.3);
    fi2.FaceColor = [1 1 1];       % make the filled area
    if ii == syn_num
    L = legend({'Control','Synergy1','Synergy2','Synergy3','Synergy4','Task Disable'},'Location','southwest');
        set(L,...
            'Position',[0.923 0.120910384068279 0.0556196623180075 0.0803628093101775],...
            'FontSize',30);
    end
    hold off;
end

%save figures
if save_fig == 1
    saveas(gcf,['EachPlot/x_corr_result/' synergy_combination '/' num2str(syn_num) 'syn_' num2str(syn_num) 'plot' '_Wsynergy.fig'])
    saveas(gcf,['EachPlot/x_corr_result/' synergy_combination '/' num2str(syn_num) 'syn_' num2str(syn_num) 'plot' '_Wsynergy.png'])
end
if save_data == 1
    for i = 1:4
        eval(['vs_synergy' num2str(i) ' = result{' num2str(i) '};'])
    end
    save(['EachPlot/x_corr_result/' synergy_combination '/x_corr_data(spacial).mat'],'vs*','days','Elapsed_days')
end
close all;
